import{a as C}from"./chunk-QFI5ZUMR.js";import{A as g,B as R,C as n,D as S,p as D,q as v,r as F,u as s,v as u,x as l,z as m}from"./chunk-JEBJIWP7.js";import{k as b,u as k,x as w}from"./chunk-TPGHJTJC.js";import{g as i}from"./chunk-PM2M367S.js";var G=class f{constructor(e,t){this._firestore=e;this._authService=t;this.userObs=this._authService.user$}famillyGroupName=null;user=null;userObs;addDefaultTask(e){return i(this,null,function*(){let t=u(e);yield g(t,{createdAt:new Date})})}clearTasksSubcollection(e,t){return i(this,null,function*(){(yield l(e)).docs.forEach(o=>{t.delete(o.ref)})})}getFamillyGroupName(){return i(this,null,function*(){if(this.user=yield b(this.userObs),!this.user)throw new Error("User does not exist.");let e=s(this._firestore,"Familly"),t=m(e,n("members","array-contains",this.user.uid)),a=yield l(t);if(a.empty)return console.log("No familly group found for the current user."),null;let o=a.docs[0].id;return console.log("Familly group name: ",o),o})}addMemberToFamillyGroup(e){return i(this,null,function*(){if(this.famillyGroupName=yield this.getFamillyGroupName(),!this.famillyGroupName)throw new Error("Current familly group name could not be retrieved.");let t=s(this._firestore,"Users"),a=m(t,n("email","==",e)),o=yield l(a);if(o.empty)throw new Error("User with the provided email does not exist.");let r=o.docs[0].get("uid");console.log("Member ID:",r);let y=u(this._firestore,"Familly",this.famillyGroupName);yield R(y,{members:D(r)});let d=s(this._firestore,"Familly"),h=m(d,n("members","array-contains",r)),T=yield l(h),p=S(this._firestore);for(let c of T.docs)if(c.id!==this.famillyGroupName){if(p.update(c.ref,{members:v(r)}),c.get("members").length>1){console.log(`Skipping task deletion for familly group ${c.id} as it still has other members.`);continue}let Q=s(c.ref,"Tasks");this.clearTasksSubcollection(Q,p)}yield p.commit(),console.log("Batch operations committed successfully.")})}createFamillyGroup(e){return i(this,null,function*(){if(this.user=yield b(this.userObs),!this.user)throw new Error("User does not exist.");let t=s(this._firestore,"Familly"),a=m(t,n("name","==",e),n("members","array-contains",this.user.uid));if(!(yield l(a)).empty)throw new Error("A family group with this name already exists. Please choose a different name.");let r=u(t);yield g(r,{name:e,members:[this.user.uid],createdAt:new Date}),console.log(`Family group '${e}' created successfully.`);let y=s(r,"Tasks");yield this.addDefaultTask(y);let d=s(r,"UserDatabase");yield this.addDefaultTask(d);let h=s(r,"Categories");yield this.addDefaultTask(h),console.log("Default task added to the new family group.")})}static \u0275fac=function(t){return new(t||f)(w(F),w(C))};static \u0275prov=k({token:f,factory:f.\u0275fac,providedIn:"root"})};export{G as a};
